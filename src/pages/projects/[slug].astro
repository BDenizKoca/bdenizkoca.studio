---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ProjectSlider from '../../components/ProjectSlider.astro';
import Lightbox from '../../components/Lightbox.astro';
import { formatDateShort, getAltLangSlug } from '../../utils';

export const getStaticPaths = (async () => {
  const allProjects = await getCollection('projects');
  const enProjects = allProjects.filter(({ data }) => data.lang === 'en');

  return enProjects.map(project => ({
    params: { slug: project.data.slug || project.slug.replace(/^en\//, '') },
    props: {
      project,
      altLangSlug: getAltLangSlug(allProjects, project.slug, 'en')
    }
  }));
}) satisfies GetStaticPaths;

const { project, altLangSlug } = Astro.props;
const { Content } = await project.render();

// Debug logging
console.log('EN Project slug:', project.slug);
console.log('Alt lang slug:', altLangSlug);

// Get the alternate language entry to check for custom slug override
let altLangUrl: string | undefined = undefined;
if (altLangSlug) {
  const altProject = await getCollection('projects').then(all => all.find(p => p.slug === altLangSlug));
  console.log('Alt project found:', altProject?.slug, 'Custom slug:', altProject?.data.slug);
  const cleanAltSlug = altProject?.data.slug || altLangSlug.replace(/^tr\//, '');
  console.log('Clean alt slug:', cleanAltSlug);
  if (cleanAltSlug) {
    altLangUrl = `/tr/projeler/${cleanAltSlug}/`;
  }
}
console.log('Final alt lang URL:', altLangUrl);
---

<BaseLayout
  title={project.data.meta_title || project.data.title}
  description={project.data.meta_description || project.data.description}
  lang="en"
  bodyClass="page-project"
  coverImage={project.data.cover_image}
  altLangUrl={altLangUrl}
  schemaType="CreativeWork"
  datePublished={project.data.date.toISOString()}
>
  <Header slot="header" lang="en" currentPath={Astro.url.pathname} altLangUrl={altLangUrl} />
  
  <article class="project-article container">
    <header class="project-header">
      <div class="project-header-content">
        <h1>{project.data.title}</h1>
        <div class="project-date-badge">
          <span class="badge-label">Published:</span> {formatDateShort(project.data.date)}
          {project.data.updated && (
            <>
              <span class="badge-separator">·</span>
              <span class="badge-label">Last Edited:</span> {formatDateShort(project.data.updated)}
            </>
          )}
        </div>
        <p class="project-description">{project.data.description}</p>
      </div>
    </header>
    {project.data.slider_items && project.data.slider_items.length > 0 ? (
      <ProjectSlider sliderItems={project.data.slider_items} projectTitle={project.data.title} />
    ) : project.data.hover_video ? (
      <div class="project-hero">
        <video src={project.data.hover_video} controls autoplay loop muted playsinline>
          Your browser does not support the video tag.
        </video>
      </div>
    ) : project.data.cover_image && (
      <div class="project-hero">
        <img src={project.data.cover_image} alt={project.data.title} loading="lazy" decoding="async" />
      </div>
    )}
    <div class="project-content prose">
      <Content />
    </div>
  </article>

  <Lightbox />

  <Footer slot="footer" lang="en" />

  <script>
    // Fetch GitHub star count
    async function fetchStarCount() {
      const starCountEl = document.querySelector('.star-count');
      if (!starCountEl) return;

      const repo = starCountEl.getAttribute('data-repo');
      if (!repo) return;

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const response = await fetch(`https://api.github.com/repos/${repo}`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        if (data.stargazers_count !== undefined) {
          starCountEl.textContent = `★ ${data.stargazers_count.toLocaleString()}`;
        }
      } catch (error) {
        console.error('Failed to fetch star count:', error);
        starCountEl.textContent = '★';
      }
    }

    fetchStarCount();
  </script>
</BaseLayout>
